<%
@boards ||= [ @board ]

if @boards
  @boards.each do |board|
%>
    App.cable.subscriptions.create({
      channel: 'BoardsChannel',
      room:    "<%= board.id %>"
    }, {
      received(data) {
        this.appendLine(data);
      },

      appendLine(data) {
        var html = this.createLine(data);
        $('[data-broadcast~="<%= board.id %>"]').append(html);
      },

      createLine(data) {
        <%
        replace_vars = {
          content: '##note.content##'
        }
        %>
        var html = '<%= escape_javascript render 'notes/note', content: replace_vars %>';

        <% replace_vars.each do |field, replace_var|
          html.replace(<%= field %>, data['<%= replace_var %>']);
        <% end %>

        return html;
      }
    });
<%
  end
end
%>
